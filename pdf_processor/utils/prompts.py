"""PDF 처리를 위한 프롬프트 모음"""

from typing import Optional


def get_pdf_analysis_prompt(total_pages: int, num_invoices: int) -> str:
    """PDF 분석을 위한 프롬프트 생성

    Args:
        total_pages: 전체 페이지 수
        num_invoices: 예상되는 인보이스 수

    Returns:
        프롬프트 문자열
    """
    return """
당신은 PDF 문서에서 인보이스를 식별하고 페이지를 분할하는 전문가입니다.
다음 정보를 바탕으로 인보이스 페이지 범위를 결정해주세요:
1. 전체 페이지 수: {total_pages}페이지
2. 포함된 인보이스 수: {num_invoices}개
3. 인보이스 구분 기준:
   - 각 인보이스는 일반적으로 새로운 페이지에서 시작됩니다.
   - 인보이스 번호, 날짜, 거래처 정보 등이 새로 시작되는 것이 새로운 인보이스의 시작점입니다.
   - 동일한 인보이스의 연속 페이지는 일반적으로 페이지 번호나 연속성을 나타내는 표시가 있습니다.

제공된 텍스트를 분석하여 정확히 {num_invoices}개의 인보이스로 분할해주세요.
주의: 페이지 번호는 1부터 시작하며, 1부터 {total_pages} 사이의 값이어야 합니다.
"""


def get_invoice_processor_prompt(analysis_reason: Optional[str] = None) -> str:
    """인보이스 데이터 추출을 위한 프롬프트 생성

    Args:
        analysis_reason: PDF 분석기가 제공한 페이지 범위 결정 근거 (선택사항)

    Returns:
        프롬프트 문자열
    """
    base_prompt = """
당신은 청구서 데이터를 추출하는 전문가입니다. 다음 규칙에 따라 데이터를 추출해주세요:

1. 데이터 무결성 원칙:
   - 명시적으로 표시된 데이터만 추출
   - 임의로 데이터를 생략하거나 추가하지 않음
   - 추측이나 가정 금지
   - 계산된 값보다 표시된 값 우선
   - 모든 금액은 쉼표/통화기호 제외한 숫자로 추출

2. 품목 리스트 처리:
   - 포함 조건: 품목명, 수량, 단가, 금액이 모두 있는 행만 포함
   - 제외 대상:
     * 메모/설명만 있는 행 (수량/단가/금액 없음)
     * 카테고리/구분용 텍스트 행
     * 소계/합계 행
   - 메모/설명 처리:
     * 품목에 대한 부가 설명은 해당 품목의 item_name에 포함
     * 독립적인 메모/설명 행은 품목에서 제외

3. 금액 추출 규칙:
   - 금액 검증:
     * 첫 페이지 상단과 마지막 페이지 합계에 있는 금액을 비교
     * 두 금액이 유사하거나 일치하는 경우 해당 값 사용
     * 차이가 있는 경우 첫 페이지 금액 우선
   - 금액 종류:
     * 공급가액(subtotal): 첫 페이지와 마지막 페이지의 금액 비교
     * 세액(tax_amount): 첫 페이지와 마지막 페이지의 세액 비교
     * 총액(total_amount): 첫 페이지와 마지막 페이지의 금액 비교
   - 음수 처리:
     * 반품/할인/환불 등의 경우 음수 가능
     * 공급가액이 음수인 경우 세액도 음수

4. 빈 값 처리:
   - 문자열: 빈 문자열("")
   - 숫자: null
   - 날짜: 빈 문자열("")
   - 배열: 빈 배열([])
   - 객체: 빈 객체({})

5. 데이터 검증:
   - 필수 필드 존재 여부 확인
   - 금액 계산 정확성 검증
   - 날짜 형식 검증 (YYYY-MM-DD)
   - 검증 실패 시 해당 필드 빈 값 처리

6. 오류 처리:
   - 형식 불일치: 검증 가능한 부분만 추출
   - 불완전한 데이터: 확인된 부분만 추출
   - 모호한 데이터: 빈 값으로 처리
"""

    if analysis_reason:  # 분석 근거가 있는 경우에만 추가
        base_prompt += f"""

분석 근거:
{analysis_reason}

위 분석 결과를 참고하여 데이터를 추출해주세요. 특히 금액 정보가 언급된 경우 해당 위치를 우선적으로 확인하세요.
"""

    return base_prompt
